<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAG System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Add Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Include MathJax with full configuration -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
          displayMath: [
            ["$$", "$$"],
            ["\\[", "\\]"],
          ],
          packages: ["base", "ams", "noerrors", "noundefined"],
          processEscapes: true,
          processEnvironments: true,
        },
        options: {
          enableMenu: false,
          processHtmlClass: "tex2jax_process",
          ignoreHtmlClass: "no-mathjax",
        },
        startup: {
          ready: function () {
            MathJax.startup.defaultReady();
          },
        },
      };
    </script>
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>

    <style>
      body {
        padding-top: 20px;
      }
      .tab-content {
        padding-top: 20px;
      }
      #chat-messages {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .user-message {
        background-color: #e9ecef;
        padding: 8px 12px;
        border-radius: 15px;
        margin-bottom: 10px;
        max-width: 75%;
        align-self: flex-end;
        margin-left: auto;
      }
      .assistant-message {
        background-color: #f8f9fa;
        padding: 8px 12px;
        border-radius: 15px;
        margin-bottom: 10px;
        max-width: 75%;
      }
      /* Add styling for rendered content */
      .assistant-message .rendered-content {
        overflow-x: auto;
      }
      .assistant-message .rendered-content pre {
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
      }
      .assistant-message .rendered-content code {
        background-color: #f1f1f1;
        padding: 2px 4px;
        border-radius: 3px;
      }
      .assistant-message .rendered-content table {
        border-collapse: collapse;
        margin: 10px 0;
        width: 100%;
      }
      .assistant-message .rendered-content th,
      .assistant-message .rendered-content td {
        border: 1px solid #ddd;
        padding: 8px;
      }
      .assistant-message .rendered-content th {
        background-color: #f2f2f2;
      }
      .spinner-container {
        display: none;
        text-align: center;
        padding: 20px;
      }
      .env-warning {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 5px;
        background-color: #fff3cd;
        border: 1px solid #ffecb5;
      }
      /* File upload styling */
      .file-upload-container {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
      }
      .file-upload-container:hover {
        border-color: #007bff;
        background-color: #f1f8ff;
      }
      .file-upload-container input {
        display: none;
      }
      .indexing-options {
        margin-bottom: 20px;
      }
      /* File list styling */
      .file-list {
        margin-top: 20px;
      }
      .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        margin-bottom: 8px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
      }
      .file-item:hover {
        background-color: #e9ecef;
      }
      .file-item .file-type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 10px;
      }
      .file-item .file-chunks {
        color: #6c757d;
        font-size: 14px;
      }
      .file-item .delete-file {
        color: #dc3545;
        cursor: pointer;
        padding: 5px 10px;
      }
      .file-item .delete-file:hover {
        color: #c82333;
      }
      .tab-separator {
        margin: 20px 0;
        border-top: 1px solid #dee2e6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center mb-4">RAG System with Azure AI Inference</h1>

      <!-- Environment check warning -->
      <div id="envWarning" class="env-warning" style="display: none">
        <strong>Warning:</strong> Some environment variables are not set
        properly. The system may not function correctly.
        <div class="mt-2">
          <a href="/setup_env" class="btn btn-warning">
            <i class="bi bi-gear-fill"></i> Setup Environment Variables
          </a>
          <button class="btn btn-sm btn-outline-secondary ms-2" onclick="checkEnvironment()">
            Check Again
          </button>
        </div>
        <div class="missing-vars mt-2" id="missingVarsList"></div>
      </div>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="index-tab"
            data-bs-toggle="tab"
            data-bs-target="#index"
            type="button"
            role="tab"
            aria-controls="index"
            aria-selected="true"
          >
            Index Documents
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="query-tab"
            data-bs-toggle="tab"
            data-bs-target="#query"
            type="button"
            role="tab"
            aria-controls="query"
            aria-selected="false"
          >
            Query Documents
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="ask-tab"
            data-bs-toggle="tab"
            data-bs-target="#ask"
            type="button"
            role="tab"
            aria-controls="ask"
            aria-selected="false"
          >
            Ask Questions
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="chat-tab"
            data-bs-toggle="tab"
            data-bs-target="#chat"
            type="button"
            role="tab"
            aria-controls="chat"
            aria-selected="false"
          >
            Chat
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="config-tab"
            data-bs-toggle="tab"
            data-bs-target="#config"
            type="button"
            role="tab"
            aria-controls="config"
            aria-selected="false"
          >
            Configuration
          </button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <!-- Index Tab -->
        <div
          class="tab-pane fade show active"
          id="index"
          role="tabpanel"
          aria-labelledby="index-tab"
        >
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Index Documents</h5>
              <p class="card-text">
                Follow these steps to make documents searchable:
                <ol>
                  <li>Upload files to the data directory</li>
                  <li>Index the files to make them searchable</li>
                </ol>
              </p>

              <!-- File Upload Section -->
              <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                  <h5 class="mb-0">Step 1: Upload Files</h5>
                </div>
                <div class="card-body">
                  <div class="file-upload-container" id="fileUploadContainer">
                    <input
                      type="file"
                      id="fileUpload"
                      accept=".pdf,.txt,.docx,.doc,.csv,.md"
                    />
                    <div>
                      <i class="bi bi-cloud-upload"></i>
                      <h5>Drag & Drop Files Here</h5>
                      <p>Or click to select files</p>
                      <p class="text-muted small">
                        Supported formats: PDF, TXT, DOCX, CSV, MD
                      </p>
                    </div>
                  </div>
                  <div class="mt-2">
                    <button id="uploadFileButton" class="btn btn-primary">
                      Upload File to Data Directory
                    </button>
                    <button id="uploadIndexButton" class="btn btn-success ms-2">
                      Upload & Index Selected File
                    </button>
                  </div>
                  
                  <div class="mt-4">
                    <h6>Files in Data Directory:</h6>
                    <div id="dataFilesContainer" class="mt-2">
                      <p>Loading files from data directory...</p>
                    </div>
                    <button id="refreshDataFilesButton" class="btn btn-sm btn-outline-secondary mt-2">
                      <i class="bi bi-arrow-repeat"></i> Refresh File List
                    </button>
                  </div>
                </div>
              </div>

              <!-- Indexing Section -->
              <div class="card">
                <div class="card-header bg-success text-white">
                  <h5 class="mb-0">Step 2: Index Files</h5>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <button id="emptyVectorDbButton" class="btn btn-danger mb-3">
                      Empty Vector Database
                    </button>
                    <p class="small text-muted">
                      This will reset the vector database but keep your files in the data directory.
                    </p>
                  </div>
                  
                  <div class="indexing-options">
                    <button id="indexButton" class="btn btn-success">
                      Index All Files in Data Directory
                    </button>
                  </div>

                  <div class="spinner-container" id="indexSpinner">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Processing documents... This might take a while.</p>
                  </div>
                  <div id="indexResult" class="mt-3"></div>
                  
                  <!-- Indexed Files Section -->
                  <div class="mt-4">
                    <h6>Currently Indexed Files:</h6>
                    <div id="indexedFilesContainer" class="mt-2">
                      <p>Loading indexed files...</p>
                    </div>
                    <button id="refreshIndexedFilesButton" class="btn btn-sm btn-outline-secondary mt-2">
                      <i class="bi bi-arrow-repeat"></i> Refresh Indexed Files
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Query Tab -->
        <div
          class="tab-pane fade"
          id="query"
          role="tabpanel"
          aria-labelledby="query-tab"
        >
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Query Documents</h5>
              <p class="card-text">
                Find relevant document chunks related to your query.
              </p>
              <div class="mb-3">
                <label for="queryInput" class="form-label">Your Query</label>
                <input
                  type="text"
                  class="form-control"
                  id="queryInput"
                  placeholder="Enter your query here"
                />
              </div>
              <button id="queryButton" class="btn btn-primary">Search</button>
              <div class="spinner-container" id="querySpinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p>Searching for relevant documents...</p>
              </div>
              <div id="queryResult" class="mt-3"></div>
            </div>
          </div>
        </div>

        <!-- Ask Tab -->
        <div
          class="tab-pane fade"
          id="ask"
          role="tabpanel"
          aria-labelledby="ask-tab"
        >
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Ask Questions</h5>
              <p class="card-text">
                Get answers to your questions based on the indexed documents.
                Azure AI Inference will generate responses using retrieved
                context.
              </p>
              <div class="mb-3">
                <label for="questionInput" class="form-label"
                  >Your Question</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="questionInput"
                  placeholder="Enter your question here"
                />
              </div>
              <button id="askButton" class="btn btn-primary">Get Answer</button>
              <div class="spinner-container" id="askSpinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p>Generating answer...</p>
              </div>
              <div id="askResult" class="mt-3"></div>
            </div>
          </div>
        </div>

        <!-- Chat Tab -->
        <div
          class="tab-pane fade"
          id="chat"
          role="tabpanel"
          aria-labelledby="chat-tab"
        >
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Chat</h5>
              <p class="card-text">
                Have a conversation with the RAG chatbot. Type 'reset' to clear
                history.
              </p>
              <div id="chat-messages"></div>
              <div class="input-group mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="chatInput"
                  placeholder="Type your message here"
                />
                <button id="chatButton" class="btn btn-primary">Send</button>
              </div>
              <div class="spinner-container" id="chatSpinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p>Getting response...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Config Tab -->
        <div
          class="tab-pane fade"
          id="config"
          role="tabpanel"
          aria-labelledby="config-tab"
        >
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Configuration</h5>
              <p class="card-text">View and manage the system configuration.</p>
              <a href="/config" class="btn btn-primary" target="_blank">
                View Full Configuration
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add a hidden resetDbCheckbox that's referenced in JavaScript -->
    <div style="display:none">
      <input type="checkbox" id="resetDbCheckbox" />
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Configure marked options with correct settings for HTML
        marked.setOptions({
          breaks: true,
          gfm: true,
          sanitize: false,
          smartypants: true,
        });

        // Significantly improved LaTeX preprocessing
        function preprocessLatex(text) {
          let processed = text;

          // First, protect all properly formatted LaTeX
          // Find all instances of $$...$$ and \[...\] and give them a unique marker
          let protectedBlocks = [];
          processed = processed.replace(
            /(\$\$[\s\S]+?\$\$)|(\\\[[\s\S]+?\\\])/g,
            function (match) {
              const id = protectedBlocks.length;
              protectedBlocks.push(match);
              return `%%PROTECTED_BLOCK_${id}%%`;
            }
          );

          // Same for inline math $...$ and \(...\)
          processed = processed.replace(
            /(\$[^\$]+?\$)|(\\\([^\)]+?\\\))/g,
            function (match) {
              const id = protectedBlocks.length;
              protectedBlocks.push(match);
              return `%%PROTECTED_BLOCK_${id}%%`;
            }
          );

          // Handle broken multi-line LaTeX blocks - finds lines ending with \ that might be part of a cases environment
          processed = processed.replace(
            /(\$\$[\s\S]*?\\\\)(\s*[\s\S]*?\$\$)/g,
            function (match, p1, p2) {
              const id = protectedBlocks.length;
              protectedBlocks.push(match);
              return `%%PROTECTED_BLOCK_${id}%%`;
            }
          );

          // Now handle the raw LaTeX notations that aren't properly formatted
          // Convert (formula) to \(formula\) if it looks like LaTeX
          processed = processed.replace(/\(([^)]+)\)/g, function (match, p1) {
            // Only convert if it looks like LaTeX
            if (
              p1.includes("\\") ||
              p1.includes("_") ||
              p1.includes("^") ||
              p1.includes("{") ||
              p1.includes("}") ||
              p1.includes("frac") ||
              p1.includes("sqrt") ||
              p1.includes("text")
            ) {
              return "\\(" + p1 + "\\)";
            }
            return match;
          });

          // Convert [formula] to $$formula$$ if it looks like display math
          processed = processed.replace(/\[([^\]]+)\]/g, function (match, p1) {
            // More comprehensive check for LaTeX content
            if (
              p1.includes("\\") ||
              p1.includes("_") ||
              p1.includes("^") ||
              p1.includes("{") ||
              p1.includes("}") ||
              p1.includes("frac") ||
              p1.includes("sqrt") ||
              p1.includes("text") ||
              p1.includes("begin") ||
              p1.includes("end") ||
              p1.includes("cases") ||
              p1.includes("align")
            ) {
              return "$$" + p1 + "$$";
            }
            return match;
          });

          // Fix common LaTeX environment issues
          processed = processed.replace(
            /begin\{cases\}([\s\S]*?)\\end\{cases\}/g,
            function (match, p1) {
              // Make sure there are double backslashes at line ends
              return (
                "\\begin{cases}" +
                p1.replace(/\n/g, " \\\\ ").replace(/\\\\ \\\\/g, "\\\\") +
                "\\end{cases}"
              );
            }
          );

          // Restore the protected blocks
          for (let i = 0; i < protectedBlocks.length; i++) {
            processed = processed.replace(
              `%%PROTECTED_BLOCK_${i}%%`,
              protectedBlocks[i]
            );
          }

          return processed;
        }

        // Check environment on load
        checkEnvironment();

        // Load indexed files on page load
        loadIndexedFiles();

        // Setup file upload container event handlers
        const fileUploadContainer = document.getElementById(
          "fileUploadContainer"
        );
        const fileUploadInput = document.getElementById("fileUpload");

        fileUploadContainer.addEventListener("click", function () {
          fileUploadInput.click();
        });

        fileUploadContainer.addEventListener("dragover", function (e) {
          e.preventDefault();
          fileUploadContainer.style.borderColor = "#007bff";
          fileUploadContainer.style.backgroundColor = "#f1f8ff";
        });

        fileUploadContainer.addEventListener("dragleave", function (e) {
          e.preventDefault();
          fileUploadContainer.style.borderColor = "#ddd";
          fileUploadContainer.style.backgroundColor = "#f8f9fa";
        });

        fileUploadContainer.addEventListener("drop", function (e) {
          e.preventDefault();
          fileUploadContainer.style.borderColor = "#ddd";
          fileUploadContainer.style.backgroundColor = "#f8f9fa";

          if (e.dataTransfer.files.length) {
            fileUploadInput.files = e.dataTransfer.files;
            const fileName = e.dataTransfer.files[0].name;
            updateFileUploadDisplay(fileName);
          }
        });

        fileUploadInput.addEventListener("change", function () {
          if (fileUploadInput.files.length) {
            const fileName = fileUploadInput.files[0].name;
            updateFileUploadDisplay(fileName);
          }
        });

        function updateFileUploadDisplay(fileName) {
          const displayDiv = fileUploadContainer.querySelector("div");
          displayDiv.innerHTML = `
            <h5>Selected File: ${fileName}</h5>
            <p>Click "Upload & Index" to process this file</p>
            <p><a href="#" id="clearFileSelection" class="text-danger">Clear selection</a></p>
          `;

          document
            .getElementById("clearFileSelection")
            .addEventListener("click", function (e) {
              e.preventDefault();
              e.stopPropagation();
              fileUploadInput.value = "";
              displayDiv.innerHTML = `
              <i class="bi bi-cloud-upload"></i>
              <h5>Drag & Drop Files Here</h5>
              <p>Or click to select files</p>
              <p class="text-muted small">Supported formats: PDF, TXT, DOCX, CSV, MD</p>
            `;
            });
        }

        // Index All Documents
        document
          .getElementById("indexButton")
          .addEventListener("click", function () {
            const resetDb = document.getElementById("resetDbCheckbox").checked;
            document.getElementById("indexSpinner").style.display = "block";
            document.getElementById("indexResult").innerHTML = "";

            const formData = new FormData();
            formData.append("reset_db", resetDb);

            fetch("/index_documents", {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                document.getElementById("indexSpinner").style.display = "none";
                if (data.success) {
                  document.getElementById("indexResult").innerHTML = `
                    <div class="alert alert-success" role="alert">
                      ${data.message}
                    </div>
                    <div class="mt-3">
                      <small class="text-muted">Details:</small>
                      <pre class="mt-2 p-2 bg-light">${
                        data.details || "No details available"
                      }</pre>
                    </div>`;

                  // Refresh the file list
                  loadIndexedFiles();
                } else {
                  document.getElementById("indexResult").innerHTML = `
                    <div class="alert alert-danger" role="alert">
                      Error: ${data.message}
                    </div>
                    <div class="mt-3">
                      <small class="text-muted">Details:</small>
                      <pre class="mt-2 p-2 bg-light">${
                        data.details || "No details available"
                      }</pre>
                    </div>`;
                }
              })
              .catch((error) => {
                document.getElementById("indexSpinner").style.display = "none";
                document.getElementById("indexResult").innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    Error: ${error.message}
                  </div>`;
              });
          });

        // Upload & Index Selected File
        document
          .getElementById("uploadIndexButton")
          .addEventListener("click", function () {
            const fileInput = document.getElementById("fileUpload");
            if (!fileInput.files || fileInput.files.length === 0) {
              document.getElementById("indexResult").innerHTML = `
                <div class="alert alert-warning" role="alert">
                  Please select a file to upload.
                </div>`;
              return;
            }

            // Validate file extension
            const fileName = fileInput.files[0].name;
            const fileExt = fileName.split('.').pop().toLowerCase();
            const validExtensions = ['pdf', 'txt', 'docx', 'doc', 'csv', 'md'];
            
            if (!validExtensions.includes(fileExt)) {
              document.getElementById("indexResult").innerHTML = `
                <div class="alert alert-warning" role="alert">
                  Invalid file type: .${fileExt}. Supported formats: PDF, TXT, DOCX, DOC, CSV, MD.
                </div>`;
              return;
            }
            
            const resetDb = document.getElementById("resetDbCheckbox")?.checked || false;
            document.getElementById("indexSpinner").style.display = "block";
            document.getElementById("indexResult").innerHTML = "";

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("reset_db", resetDb);
            formData.append("index_after_upload", "true"); // Explicitly set to index after upload

            fetch("/index_documents", {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                document.getElementById("indexSpinner").style.display = "none";
                if (data.success) {
                  document.getElementById("indexResult").innerHTML = `
                        <div class="alert alert-success" role="alert">
                            ${data.message}
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Details:</small>
                            <pre class="mt-2 p-2 bg-light">${data.details || 'No details available'}</pre>
                        </div>`;

                  // Reset file input
                  fileInput.value = "";
                  const displayDiv = document.getElementById("fileUploadContainer").querySelector("div");
                  displayDiv.innerHTML = `
                    <i class="bi bi-cloud-upload"></i>
                    <h5>Drag & Drop Files Here</h5>
                    <p>Or click to select files</p>
                    <p class="text-muted small">Supported formats: PDF, TXT, DOCX, CSV, MD</p>
                  `;

                  // Refresh the file list
                  loadIndexedFiles();
                  loadDataFiles();
                } else {
                  document.getElementById("indexResult").innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            Error: ${data.message}
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Details:</small>
                            <pre class="mt-2 p-2 bg-light">${data.details || 'No details available'}</pre>
                        </div>`;
                }
              })
              .catch((error) => {
                document.getElementById("indexSpinner").style.display = "none";
                document.getElementById("indexResult").innerHTML = `
                  <div class="alert alert-danger" role="alert">
                      Error: ${error.message}
                  </div>`;
              });
          });

        // Function to load indexed files
        function loadIndexedFiles() {
          const filesContainer = document.getElementById(
            "indexedFilesContainer"
          );
          filesContainer.innerHTML = `
            <div class="spinner-border text-primary spinner-border-sm" role="status">
              <span class="visually-hidden">Loading...</span>
            </div> Loading indexed files...`;

          fetch("/list_documents")
            .then((response) => response.json())
            .then((data) => {
              if (data.success && data.files && data.files.length > 0) {
                let filesHTML = `<div class="file-list">`;

                data.files.forEach((file) => {
                  // Generate a color based on file type
                  const fileTypeColors = {
                    pdf: "bg-danger text-white",
                    txt: "bg-success text-white",
                    docx: "bg-primary text-white",
                    csv: "bg-warning text-dark",
                    md: "bg-info text-dark",
                    default: "bg-secondary text-white",
                  };

                  const colorClass =
                    fileTypeColors[file.type] || fileTypeColors.default;

                  filesHTML += `
                    <div class="file-item" data-filename="${file.name}">
                      <div>
                        <span class="file-type-badge ${colorClass}">${file.type}</span>
                        <span>${file.name}</span>
                        <span class="file-chunks">(${file.chunks} chunks)</span>
                      </div>
                    </div>
                  `;
                });

                filesHTML += `</div>`;
                filesContainer.innerHTML = filesHTML;
              } else {
                filesContainer.innerHTML = `
                  <div class="alert alert-info" role="alert">
                    No indexed files found. Upload or index documents to see them here.
                  </div>`;
              }
            })
            .catch((error) => {
              filesContainer.innerHTML = `
                <div class="alert alert-danger" role="alert">
                  Error loading indexed files: ${error.message}
                </div>`;
            });
        }

        // Make deleteFile function available globally
        window.deleteFile = function (filename) {
          // Use a custom confirm dialog to provide option
          if (confirm(`Delete "${filename}" from index?`)) {
            const deleteFromData = confirm(`Also delete the file "${filename}" from the data directory?`);
            
            document.getElementById("indexSpinner").style.display = "block";
      
            fetch("/delete_document", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ 
                filename: filename,
                delete_from_data: deleteFromData 
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                document.getElementById("indexSpinner").style.display = "none";
                if (data.success) {
                  document.getElementById("indexResult").innerHTML = `
                    <div class="alert alert-success" role="alert">
                      ${data.message}
                    </div>`;
      
                  // Refresh both file lists
                  loadIndexedFiles();
                  if (deleteFromData) {
                    loadDataFiles();
                  }
                } else {
                  document.getElementById("indexResult").innerHTML = `
                    <div class="alert alert-danger" role="alert">
                      Error: ${data.message}
                    </div>
                    <div class="mt-3">
                      <small class="text-muted">Details:</small>
                      <pre class="mt-2 p-2 bg-light">${
                        data.details || "No details available"
                      }</pre>
                    </div>`;
                }
              })
              .catch((error) => {
                document.getElementById("indexSpinner").style.display = "none";
                document.getElementById("indexResult").innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    Error: ${error.message}
                  </div>`;
              });
          }
        };

        // Refresh file list when index tab is shown
        document
          .querySelector('button[data-bs-target="#index"]')
          .addEventListener("click", loadIndexedFiles);

        // Query Documents
        document
          .getElementById("queryButton")
          .addEventListener("click", function () {
            const query = document.getElementById("queryInput").value.trim();
            if (!query) {
              document.getElementById("queryResult").innerHTML = `
                        <div class="alert alert-warning" role="alert">
                            Please enter a query.
                        </div>`;
              return;
            }

            document.getElementById("querySpinner").style.display = "block";
            document.getElementById("queryResult").innerHTML = "";

            const formData = new FormData();
            formData.append("query", query);

            fetch("/query", {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                document.getElementById("querySpinner").style.display = "none";
                if (data.success) {
                  let resultsHTML = `<h4 class="mt-4">Results for: "${data.query}"</h4>`;
                  if (data.results.length > 0) {
                    resultsHTML += '<div class="list-group">';
                    data.results.forEach((result) => {
                      resultsHTML += `
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">Result ${result.id}</h5>
                                            <small>Similarity: ${result.similarity}</small>
                                        </div>
                                        <p class="mb-1"><strong>Source:</strong> ${result.source}, Page: ${result.page}</p>
                                        <p class="mb-1">${result.content}</p>
                                    </div>`;
                    });
                    resultsHTML += "</div>";
                  } else {
                    resultsHTML += `<div class="alert alert-info">No results found.</div>`;
                  }
                  document.getElementById("queryResult").innerHTML =
                    resultsHTML;
                } else {
                  document.getElementById("queryResult").innerHTML = `
                            <div class="alert alert-danger" role="alert">
                                Error: ${data.message}
                            </div>`;
                }
              })
              .catch((error) => {
                document.getElementById("querySpinner").style.display = "none";
                document.getElementById("queryResult").innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            Error: ${error.message}
                        </div>`;
              });
          });

        // Ask Question
        document
          .getElementById("askButton")
          .addEventListener("click", function () {
            const question = document
              .getElementById("questionInput")
              .value.trim();
            if (!question) {
              document.getElementById("askResult").innerHTML = `
                        <div class="alert alert-warning" role="alert">
                            Please enter a question.
                        </div>`;
              return;
            }

            document.getElementById("askSpinner").style.display = "block";
            document.getElementById("askResult").innerHTML = "";

            const formData = new FormData();
            formData.append("query", question);

            fetch("/ask", {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                document.getElementById("askSpinner").style.display = "none";
                if (data.success) {
                  // Create the card container
                  const cardContainer = document.createElement("div");
                  cardContainer.className = "card mt-3";

                  // Create the card header
                  const cardHeader = document.createElement("div");
                  cardHeader.className = "card-header";
                  cardHeader.innerHTML = `<strong>Question:</strong> ${data.question}`;

                  // Create the card body
                  const cardBody = document.createElement("div");
                  cardBody.className = "card-body";

                  // Create a div for rendered content with markdown and LaTeX
                  const renderedContent = document.createElement("div");
                  renderedContent.className =
                    "rendered-content tex2jax_process";

                  // Apply the same preprocessing for LaTeX and markdown as in chat
                  const processedText = preprocessLatex(data.answer);

                  // Process markdown
                  renderedContent.innerHTML = marked.parse(processedText);

                  // Add rendered content to card body
                  cardBody.appendChild(renderedContent);

                  // Assemble the card
                  cardContainer.appendChild(cardHeader);
                  cardContainer.appendChild(cardBody);

                  // Add to DOM
                  document
                    .getElementById("askResult")
                    .appendChild(cardContainer);

                  // Render LaTeX with MathJax
                  if (
                    window.MathJax &&
                    typeof window.MathJax.typesetPromise === "function"
                  ) {
                    try {
                      window.MathJax.typesetPromise([renderedContent]).catch(
                        function (err) {
                          console.log("MathJax error:", err);
                        }
                      );
                    } catch (error) {
                      console.error("Error rendering math:", error);
                    }
                  }
                } else {
                  document.getElementById("askResult").innerHTML = `
                            <div class="alert alert-danger" role="alert">
                                Error: ${data.message}
                            </div>
                            ${
                              data.details
                                ? `<pre class="mt-2 p-2 bg-light">${data.details}</pre>`
                                : ""
                            }`;
                }
              })
              .catch((error) => {
                document.getElementById("askSpinner").style.display = "none";
                document.getElementById("askResult").innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            Error: ${error.message}
                        </div>`;
              });
          });

        // Load chat history with improved rendering
        function loadChatHistory() {
          fetch("/chat_history")
            .then((response) => response.json())
            .then((data) => {
              const chatMessages = document.getElementById("chat-messages");
              chatMessages.innerHTML = "";

              data.forEach((message) => {
                const userDiv = document.createElement("div");
                userDiv.className = "user-message";
                userDiv.textContent = message.user;
                chatMessages.appendChild(userDiv);

                const assistantDiv = document.createElement("div");
                assistantDiv.className = "assistant-message";

                // Create a div for rendered content
                const renderedContent = document.createElement("div");
                renderedContent.className = "rendered-content tex2jax_process";

                // Enhanced preprocessing for all LaTeX formats
                const processedText = preprocessLatex(message.assistant);

                // Process markdown
                renderedContent.innerHTML = marked.parse(processedText);
                assistantDiv.appendChild(renderedContent);
                chatMessages.appendChild(assistantDiv);

                // Render LaTeX with MathJax
                if (
                  window.MathJax &&
                  typeof window.MathJax.typesetPromise === "function"
                ) {
                  try {
                    window.MathJax.typesetPromise([renderedContent]).catch(
                      function (err) {
                        console.log("MathJax error:", err);
                      }
                    );
                  } catch (error) {
                    console.error("Error rendering math:", error);
                  }
                }
              });

              // Scroll to bottom
              chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        // Initialize chat history when tab is shown
        document
          .querySelector('button[data-bs-target="#chat"]')
          .addEventListener("click", loadChatHistory);

        // Chat functionality
        document
          .getElementById("chatButton")
          .addEventListener("click", sendChatMessage);
        document
          .getElementById("chatInput")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              sendChatMessage();
            }
          });

        function sendChatMessage() {
          const message = document.getElementById("chatInput").value.trim();
          if (!message) {
            return;
          }

          // Add user message to the chat
          const chatMessages = document.getElementById("chat-messages");
          const userDiv = document.createElement("div");
          userDiv.className = "user-message";
          userDiv.textContent = message;
          chatMessages.appendChild(userDiv);

          // Clear input
          document.getElementById("chatInput").value = "";

          // Show spinner
          document.getElementById("chatSpinner").style.display = "block";

          const formData = new FormData();
          formData.append("message", message);

          fetch("/chat", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              document.getElementById("chatSpinner").style.display = "none";

              if (data.success) {
                const assistantDiv = document.createElement("div");
                assistantDiv.className = "assistant-message";

                // Create a div for rendered content
                const renderedContent = document.createElement("div");
                renderedContent.className = "rendered-content tex2jax_process";

                // Enhanced preprocessing for all LaTeX formats
                const processedText = preprocessLatex(data.response);

                // Process markdown
                renderedContent.innerHTML = marked.parse(processedText);
                assistantDiv.appendChild(renderedContent);
                chatMessages.appendChild(assistantDiv);

                // Render LaTeX with MathJax
                if (
                  window.MathJax &&
                  typeof window.MathJax.typesetPromise === "function"
                ) {
                  try {
                    window.MathJax.typesetPromise([renderedContent]).catch(
                      function (err) {
                        console.log("MathJax error:", err);
                      }
                    );
                  } catch (error) {
                    console.error("Error rendering math:", error);
                  }
                }

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
              } else {
                const errorDiv = document.createElement("div");
                errorDiv.className = "alert alert-danger";
                errorDiv.textContent = `Error: ${data.message}`;
                chatMessages.appendChild(errorDiv);
              }
            })
            .catch((error) => {
              document.getElementById("chatSpinner").style.display = "none";

              const errorDiv = document.createElement("div");
              errorDiv.className = "alert alert-danger";
              errorDiv.textContent = `Error: ${error.message}`;
              chatMessages.appendChild(errorDiv);
            });
        }

        // Environment check function
        function checkEnvironment() {
          fetch("/check_env")
            .then((response) => response.json())
            .then((data) => {
              if (!data.all_set) {
                document.getElementById("envWarning").style.display = "block";

                let missingVars = [];
                if (!data.github_token) missingVars.push("GITHUB_TOKEN");
                if (!data.azure_endpoint)
                  missingVars.push("AZURE_INFERENCE_ENDPOINT");
                if (!data.chat_model)
                  missingVars.push("AZURE_INFERENCE_CHAT_MODEL");
                if (!data.embedding_model)
                  missingVars.push("AZURE_INFERENCE_EMBEDDING_MODEL");

                // Display missing variables in a more structured way
                const missingVarsList = document.getElementById("missingVarsList");
                if (missingVars.length > 0) {
                  missingVarsList.innerHTML = `
                    <span class="text-danger">Missing variables:</span>
                    <ul class="mb-0 ps-4">
                      ${missingVars.map(v => `<li>${v}</li>`).join('')}
                    </ul>
                  `;
                }
              } else {
                document.getElementById("envWarning").style.display = "none";
              }
            })
            .catch((error) => {
              console.error("Error checking environment:", error);
            });
        }

        // Load data directory files on page load
        loadDataFiles();
    
        // Function to load files from data directory
        function loadDataFiles() {
          const dataFilesContainer = document.getElementById("dataFilesContainer");
          dataFilesContainer.innerHTML = `
            <div class="spinner-border text-primary spinner-border-sm" role="status">
              <span class="visually-hidden">Loading...</span>
            </div> Loading files...`;
            
          fetch("/list_data_files")
            .then(response => response.json())
            .then(data => {
              if (data.success && data.files && data.files.length > 0) {
                let filesHTML = `<div class="table-responsive"><table class="table table-sm table-hover">
                  <thead>
                    <tr>
                      <th>File Name</th>
                      <th>Type</th>
                      <th>Size</th>
                      <th>Indexable</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>`;
                  
                data.files.forEach(file => {
                  // Generate a badge for indexable status
                  const indexableBadge = file.indexable ? 
                    '<span class="badge bg-success">Yes</span>' : 
                    '<span class="badge bg-secondary">No</span>';
                    
                  filesHTML += `
                    <tr>
                      <td>${file.name}</td>
                      <td><span class="badge bg-info">${file.type}</span></td>
                      <td>${file.size_kb.toFixed(2)} KB</td>
                      <td>${indexableBadge}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteDataFile('${file.name}')">
                          <i class="bi bi-trash"></i> Delete
                        </button>
                      </td>
                    </tr>
                  `;
                });
                  
                filesHTML += `</tbody></table></div>`;
                dataFilesContainer.innerHTML = filesHTML;
              } else if (data.success && (!data.files || data.files.length === 0)) {
                dataFilesContainer.innerHTML = `
                  <div class="alert alert-info" role="alert">
                    No files found in data directory. Upload files first.
                  </div>`;
              } else {
                dataFilesContainer.innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    Error: ${data.message || "Unknown error"}
                  </div>`;
              }
            })
            .catch(error => {
              dataFilesContainer.innerHTML = `
                <div class="alert alert-danger" role="alert">
                  Error loading files: ${error.message}
                </div>`;
            });
        }
        
        // Add function to delete a file from data directory
        window.deleteDataFile = function(filename) {
          if (confirm(`Are you sure you want to delete "${filename}" from the data directory? This will not affect the index.`)) {
            document.getElementById("indexSpinner").style.display = "block";
            
            fetch("/delete_data_file", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ filename: filename }),
            })
              .then(response => response.json())
              .then(data => {
                document.getElementById("indexSpinner").style.display = "none";
                if (data.success) {
                  document.getElementById("indexResult").innerHTML = `
                    <div class="alert alert-success" role="alert">
                      ${data.message}
                    </div>`;
                    
                  // Refresh the data files list
                  loadDataFiles();
                } else {
                  document.getElementById("indexResult").innerHTML = `
                    <div class="alert alert-danger" role="alert">
                      Error: ${data.message}
                    </div>`;
                }
              })
              .catch(error => {
                document.getElementById("indexSpinner").style.display = "none";
                document.getElementById("indexResult").innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    Error: ${error.message}
                  </div>`;
              });
          }
        };

        // Upload File button handler
        document.getElementById("uploadFileButton").addEventListener("click", function() {
          const fileInput = document.getElementById("fileUpload");
          if (!fileInput.files || fileInput.files.length === 0) {
            document.getElementById("indexResult").innerHTML = `
              <div class="alert alert-warning" role="alert">
                Please select a file to upload.
              </div>`;
            return;
          }
          
          // Validate file extension
          const fileName = fileInput.files[0].name;
          const fileExt = fileName.split('.').pop().toLowerCase();
          const validExtensions = ['pdf', 'txt', 'docx', 'doc', 'csv', 'md'];
          
          if (!validExtensions.includes(fileExt)) {
            document.getElementById("indexResult").innerHTML = `
              <div class="alert alert-warning" role="alert">
                Invalid file type: .${fileExt}. Supported formats: PDF, TXT, DOCX, DOC, CSV, MD.
              </div>`;
            return;
          }
          
          document.getElementById("indexSpinner").style.display = "block";
          document.getElementById("indexResult").innerHTML = "";
          
          const formData = new FormData();
          formData.append("file", fileInput.files[0]);
          formData.append("index_after_upload", "false"); // Explicitly set to NOT index
          
          fetch("/index_documents", {
            method: "POST",
            body: formData,
          })
            .then(response => response.json())
            .then(data => {
              document.getElementById("indexSpinner").style.display = "none";
              if (data.success) {
                document.getElementById("indexResult").innerHTML = `
                  <div class="alert alert-success" role="alert">
                    File uploaded to data directory successfully!
                  </div>`;
                  
                // Reset file input
                fileInput.value = "";
                const displayDiv = document.getElementById("fileUploadContainer").querySelector("div");
                displayDiv.innerHTML = `
                  <i class="bi bi-cloud-upload"></i>
                  <h5>Drag & Drop Files Here</h5>
                  <p>Or click to select files</p>
                  <p class="text-muted small">Supported formats: PDF, TXT, DOCX, CSV, MD</p>
                `;
                
                // Refresh the data files list
                loadDataFiles();
              } else {
                document.getElementById("indexResult").innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    Error: ${data.message}
                  </div>
                  <div class="mt-3">
                    <small class="text-muted">Details:</small>
                    <pre class="mt-2 p-2 bg-light">${data.details || 'No details available'}</pre>
                  </div>`;
              }
            })
            .catch(error => {
              document.getElementById("indexSpinner").style.display = "none";
              document.getElementById("indexResult").innerHTML = `
                <div class="alert alert-danger" role="alert">
                  Error: ${error.message}
                </div>`;
            });
        });
        
        // Empty Vector Database button handler
        document.getElementById("emptyVectorDbButton").addEventListener("click", function() {
          if (confirm("Are you sure you want to empty the vector database? This will remove all indexed documents but keep your files in the data directory.")) {
            document.getElementById("indexSpinner").style.display = "block";
            document.getElementById("indexResult").innerHTML = "";
            
            fetch("/empty_vector_db", {
              method: "POST"
            })
              .then(response => response.json())
              .then(data => {
                document.getElementById("indexSpinner").style.display = "none";
                if (data.success) {
                  document.getElementById("indexResult").innerHTML = `
                    <div class="alert alert-success" role="alert">
                      ${data.message}
                    </div>
                    <p class="small text-muted">Backup created at: ${data.backup || 'No backup'}</p>`;
                    
                  // Refresh the indexed files list
                  loadIndexedFiles();
                } else {
                  document.getElementById("indexResult").innerHTML = `
                    <div class="alert alert-danger" role="alert">
                      Error: ${data.message}
                    </div>
                    <div class="mt-3">
                      <small class="text-muted">Details:</small>
                      <pre class="mt-2 p-2 bg-light">${data.details || 'No details available'}</pre>
                    </div>`;
                }
              })
              .catch(error => {
                document.getElementById("indexSpinner").style.display = "none";
                document.getElementById("indexResult").innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    Error: ${error.message}
                  </div>`;
              });
          }
        });
        
        // Refresh Data Files button handler
        document.getElementById("refreshDataFilesButton").addEventListener("click", loadDataFiles);
        
        // Refresh Indexed Files button handler
        document.getElementById("refreshIndexedFilesButton").addEventListener("click", loadIndexedFiles);
        
        // Modify the Index All Files button handler (remove resetDb option)
        document.getElementById("indexButton").addEventListener("click", function() {
          document.getElementById("indexSpinner").style.display = "block";
          document.getElementById("indexResult").innerHTML = "";
          
          const formData = new FormData();
          
          fetch("/index_documents", {
            method: "POST",
            body: formData
          })
            .then(response => response.json())
            .then(data => {
              document.getElementById("indexSpinner").style.display = "none";
              if (data.success) {
                document.getElementById("indexResult").innerHTML = `
                  <div class="alert alert-success" role="alert">
                    ${data.message}
                  </div>
                  <div class="mt-3">
                    <small class="text-muted">Details:</small>
                    <pre class="mt-2 p-2 bg-light">${data.details || 'No details available'}</pre>
                  </div>`;
                  
                // Refresh the indexed files list
                loadIndexedFiles();
              } else {
                document.getElementById("indexResult").innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    Error: ${data.message}
                  </div>
                  <div class="mt-3">
                    <small class="text-muted">Details:</small>
                    <pre class="mt-2 p-2 bg-light">${data.details || 'No details available'}</pre>
                  </div>`;
              }
            })
            .catch(error => {
              document.getElementById("indexSpinner").style.display = "none";
              document.getElementById("indexResult").innerHTML = `
                <div class="alert alert-danger" role="alert">
                  Error: ${error.message}
                </div>`;
            });
        });

        // Refresh both file lists when index tab is shown
        document.querySelector('button[data-bs-target="#index"]').addEventListener("click", function() {
          loadDataFiles();
          loadIndexedFiles();
        });
      });
    </script>
  </body>
</html>
